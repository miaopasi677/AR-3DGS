# 🔍 视频显示问题调试指南

## 🐛 问题描述

用户反馈"现在又没视频了"，需要系统性地诊断问题。

## 📊 从日志分析的情况

### ✅ 正常的部分
- 分辨率优化成功：460800字节（640×480）
- WebSocket连接成功
- 流创建成功
- 至少处理了一帧数据

### ❌ 异常的部分
- 只有很少的数据块被处理
- 没有持续的数据流
- Android端可能没有接收到处理后的数据

## 🔍 可能的原因

### 1. Android端帧捕获问题
```
可能原因：
- 摄像头预览回调没有持续触发
- setOneShotPreviewCallback只触发一次
- 帧捕获循环停止工作
```

### 2. WebSocket连接问题
```
可能原因：
- WebSocket连接中断
- 数据传输失败
- 事件监听器没有正确触发
```

### 3. 数据处理队列问题
```
可能原因：
- 处理后的数据队列为空
- 数据处理线程停止
- 队列阻塞或超时
```

## 🛠️ 调试步骤

### 步骤1: 检查Android日志
使用adb查看详细日志：
```bash
adb logcat | grep -E "(StreamingCameraActivity|StreamingManager|ProcessedVideoView)"
```

关键日志信息：
- ✅ "捕获帧数据: XXX bytes" - 帧捕获正常
- ✅ "数据块发送成功" - 网络上传正常
- ✅ "接收到处理后数据: XXX bytes" - WebSocket接收正常
- ✅ "转换YUV数据" - 视频转换正常

### 步骤2: 检查服务器日志
观察服务器日志：
```bash
# 应该看到持续的数据处理
INFO:__main__:处理视频数据: 原始大小=460800, 处理后大小=460808

# 应该看到WebSocket数据推送
# (在调试模式下会有更多日志)
```

### 步骤3: 检查网络连接
```bash
# 测试HTTP连接
curl http://192.168.2.19:5000/

# 测试WebSocket连接
# 使用浏览器开发者工具或WebSocket测试工具
```

## 🔧 已添加的调试改进

### 1. Android端调试日志
```kotlin
// StreamingManager.kt
Log.d(TAG, "接收到处理后数据: ${decodedData.size} bytes")

// StreamingCameraActivity.kt
Log.d(TAG, "捕获帧数据: ${data.size} bytes")
Log.d(TAG, "数据块发送成功")
Log.d(TAG, "接收到处理后数据: ${data.size} bytes")
```

### 2. 后端调试优化
```python
# 调整WebSocket推送频率匹配帧捕获
time.sleep(0.2)  # 5 FPS

# 减少日志输出频率
if process_video_chunk.log_count % 10 == 1:
    logger.info(f"处理视频数据...")
```

## 🎯 诊断检查清单

### Android端检查
- [ ] 摄像头权限已授予
- [ ] 摄像头预览正常启动
- [ ] 帧捕获循环正在运行
- [ ] 网络请求成功发送
- [ ] WebSocket连接建立成功
- [ ] WebSocket事件监听器正常
- [ ] 处理后数据接收正常
- [ ] ProcessedVideoView显示正常

### 服务器端检查
- [ ] 流创建成功
- [ ] 数据块持续接收
- [ ] 视频数据处理正常
- [ ] 处理后数据入队成功
- [ ] WebSocket客户端连接正常
- [ ] 处理后数据推送正常

### 网络检查
- [ ] 设备在同一网络
- [ ] 防火墙允许5000端口
- [ ] HTTP请求正常
- [ ] WebSocket连接稳定

## 🚨 常见问题和解决方案

### 问题1: 只处理一帧就停止
**可能原因**: `setOneShotPreviewCallback`只触发一次
**解决方案**: 检查帧捕获循环是否正常运行

### 问题2: WebSocket连接中断
**可能原因**: 网络不稳定或服务器重启
**解决方案**: 添加重连机制

### 问题3: 数据队列为空
**可能原因**: 处理线程停止或队列阻塞
**解决方案**: 检查队列状态和线程状态

### 问题4: 内存不足
**可能原因**: 大量Bitmap创建导致OOM
**解决方案**: 使用对象复用和内存优化

## 🔄 测试流程

### 1. 基础功能测试
```bash
# 测试服务器API
python test_websocket_processed.py

# 应该看到：
✅ 成功接收到 5 个处理后数据块
```

### 2. Android应用测试
```
1. 安装最新APK
2. 启动应用
3. 授予所有权限
4. 点击"开始流传输"
5. 观察日志输出
6. 点击"切换视图"
7. 检查视频显示
```

### 3. 端到端测试
```
1. 同时观察Android日志和服务器日志
2. 确认数据流的完整路径：
   摄像头 → 帧捕获 → HTTP上传 → 服务器处理 → WebSocket推送 → Android接收 → 视频显示
```

## 📝 下一步行动

### 立即行动
1. 安装更新的APK到设备
2. 使用adb logcat查看详细日志
3. 同时观察服务器日志
4. 识别数据流中断的具体位置

### 如果问题持续
1. 添加更多调试日志
2. 实现WebSocket重连机制
3. 优化帧捕获逻辑
4. 考虑使用不同的视频传输方案

---

*调试指南创建时间: 2026-02-05*  
*状态: 等待用户测试反馈* 🔍